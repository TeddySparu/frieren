<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>L'Ordre de Frieren & Jägermeister</title>
  <meta name="description" content="Une secte sur la déesse Frieren et la boisson sacrée de la jagermeister qui méérite le respect et l'admiration.">
  <meta name="keywords" content="Frieren, Jagermeister, secte, Ordre">
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <style>
    *{box-sizing:border-box}
    body{background:linear-gradient(90deg,magenta,lime,cyan,yellow);font-family:"Comic Sans MS",cursive;color:#00f;margin:0;text-align:center}
    header{background:repeating-linear-gradient(45deg,red,red 10px,blue 10px,blue 20px);color:#0f0;padding:20px;border:5px dotted orange}
    h1{font-size:48px;text-shadow:3px 3px yellow;transform:skewX(-10deg)}
    nav a{margin:0 10px;color:#f0f;font-size:22px;background:#0ff;padding:5px 10px;border:3px dashed purple;cursor:pointer;text-decoration:none}
    .card{margin:20px;padding:20px;border:7px ridge pink;background:linear-gradient(45deg,#f60,#0fc,#f0f);font-size:20px;display:none}
    .card.active{display:block}
    .auth-container{display:flex;justify-content:center;gap:20px;flex-wrap:wrap}
    .auth-form{width:300px}
    form{background:linear-gradient(90deg,pink,violet,turquoise);padding:20px;border:6px dotted red;margin:20px auto;width:60%;max-width:500px}
    input,textarea,select{display:block;width:80%;margin:10px auto;padding:10px;border:5px inset yellow;background:#ffeb3b}
    button{background:lime;font-size:24px;border:4px outset cyan;padding:10px 20px;cursor:pointer;margin:5px}
    button:disabled{background:#ccc;cursor:not-allowed}
    .hidden{display:none!important}
    .error{background:red;color:white;padding:10px;margin:10px;border-radius:5px}
    .success{background:green;color:white;padding:10px;margin:10px;border-radius:5px}
    .chat-layout{display:flex;max-width:1200px;margin:0 auto;gap:20px}
    #messages{height:400px;overflow-y:auto;background:rgba(255,255,255,0.2);border:5px groove lime;padding:10px;margin:20px 0;text-align:left}
    .message{background:rgba(0,255,255,0.3);margin:5px 0;padding:10px;border:2px solid purple;border-radius:10px;position:relative}
    .message img{max-width:300px;max-height:300px;border:3px solid lime;border-radius:10px;cursor:pointer;margin:5px 0}
    .message .username{font-weight:bold;color:#f0f}
    .message .username.admin{color:#f00}
    .message .username.admin::after{content:" 👑"}
    .message .timestamp{font-size:12px;color:#666;float:right}
    .message .actions{margin-top:5px}
    .message button{font-size:12px;padding:3px 8px;margin:2px}
    #online-users{width:250px;background:rgba(255,255,255,0.3);border:5px groove lime;padding:15px;height:500px;overflow-y:auto}
    .user-item{background:rgba(255,255,255,0.4);margin:5px 0;padding:8px;border-radius:8px;font-size:14px;display:flex;justify-content:space-between;align-items:center}
    .user-item.online{border-left:5px solid #0f0}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:9999}
    .modal-content{background:linear-gradient(45deg,#f60,#0fc,#f0f);padding:30px;border:5px solid lime;border-radius:20px;max-width:500px;width:90%}
    .admin-panel{background:rgba(255,0,0,0.2);border:5px solid red;padding:15px;margin:20px;border-radius:15px}
    /* Fix pour l'espacement du message de bienvenue */
    #user-info{margin-top:10px;padding-top:10px;clear:both;}
  </style>
</head>
<body>
  <div id="loading">🔥 Initialisation de la connexion cosmique... 🔥</div>
  
  <div id="app" class="hidden">
    <header>
      <h1>🔥 L'Ordre Sacré de Frieren & Jägermeister 🔥</h1>
      <nav>
        <a onclick="show('home')">Accueil</a>
        <a onclick="show('creed')">Préceptes</a>
        <a onclick="show('rituals')">Rituels</a>
        <a onclick="show('offerings')">Offrandes</a>
        <a onclick="show('chat')" id="chat-nav" class="hidden">Chat</a>
        <a onclick="show('admin')" id="admin-nav" class="hidden">Admin 👑</a>
        <a onclick="show('auth')" id="auth-nav">Connexion</a>
        <a onclick="logout()" id="logout-nav" class="hidden">Déconnexion</a>
      </nav>
      <div id="user-info" class="hidden"><span id="welcome-msg"></span></div>
    </header>

    <main>
      <div id="home" class="card active">
        <h2>Bienvenue Voyageur Cosmique ✨</h2>
        <p>Ici on mélange la sagesse éternelle de Frieren et la puissance mystique de la Jägermeister.</p>
        <img src="https://pbs.twimg.com/media/GBh8vx-awAA1n-L.jpg" alt="Frieren" style="max-width:300px;border:10px groove lime;">
      </div>

      <div id="creed" class="card">
        <h3>📜 Préceptes sacrés</h3>
        <ul><li>Ne bois que quand tu oublies pourquoi tu bois.</li><li>Frieren est la seule réponse.</li><li>Le vert fluo est la couleur de la vérité.</li></ul>
      </div>

      <div id="rituals" class="card">
        <h3>🔮 Rituels sacrés</h3>
        <p>On danse autour d'un frigo vide et on crie « POUR FRIEREN ».</p>
      </div>

      <div id="offerings" class="card">
        <h3>🍹 Offrandes sacrées</h3>
        <p>Soupe de chips + Jägermeister + glaçons fluorescents.</p>
      </div>

      <div id="auth" class="card">
        <h3>🔐 Rejoindre la secte</h3>
        <div class="auth-container">
          <div class="auth-form">
            <h4>📝 Créer un compte</h4>
            <form id="register-form">
              <input type="text" id="register-username" placeholder="Nom cosmique" required>
              <input type="email" id="register-email" placeholder="Email" required>
              <input type="password" id="register-password" placeholder="Mot de passe" required>
              <button type="submit">🌟 Rejoindre</button>
            </form>
          </div>
          <div class="auth-form">
            <h4>🚪 Se connecter</h4>
            <form id="login-form">
              <input type="email" id="login-email" placeholder="Email" required>
              <input type="password" id="login-password" placeholder="Mot de passe" required>
              <button type="submit">⚡ Connexion</button>
            </form>
          </div>
        </div>
        <div id="auth-error" class="error hidden"></div>
      </div>

      <div id="admin" class="card">
        <div class="admin-panel">
          <h3>👑 Panel Admin</h3>
          <button onclick="clearAllMessages()">🗑️ Vider Chat</button>
          <button onclick="showUserManagement()">👥 Mute Utilisateurs</button>
        </div>
      </div>

      <div id="user-management" class="card">
        <div class="admin-panel">
          <h3>👥 Gestion Utilisateurs</h3>
          <button onclick="show('admin')" style="float:right;">← Retour</button>
          <div id="users-management-list"></div>
        </div>
      </div>

      <div id="chat" class="card">
        <h3>💬 Chat Sacré</h3>
        <div class="chat-layout">
          <div style="flex:1;">
            <div id="messages"></div>
            <div>
              <input type="text" id="message-input" placeholder="Sagesse cosmique..." maxlength="500" style="width:50%;display:inline-block;">
              <input type="file" id="image-input" accept="image/*,.gif" style="display:none;" multiple>
              <button onclick="document.getElementById('image-input').click()" style="width:20%;background:#ff69b4;">📷</button>
              <button onclick="sendMessage()" style="width:20%;">🚀</button>
            </div>
          </div>
          <div id="online-users">
            <h4 style="margin-top:0;color:#f0f;">👥 Connectés</h4>
            <div id="users-list"></div>
          </div>
        </div>
      </div>
    </main>

    <footer style="background:#f0f;color:#0ff;padding:20px;">
      <p>© 1987-2025 — L'Ordre de Frieren & Jägermeister</p>
    </footer>
  </div>

  <!-- Modals -->
  <div id="mute-modal" class="modal hidden">
    <div class="modal-content">
      <h3>🔇 Muter Utilisateur</h3>
      <p id="mute-user-info"></p>
      <input type="text" id="mute-reason" placeholder="Raison (optionnel)">
      <select id="mute-duration">
        <option value="300">5 minutes</option>
        <option value="1800">30 minutes</option>
        <option value="3600">1 heure</option>
        <option value="86400">24 heures</option>
        <option value="604800">7 jours</option>
        <option value="permanent">Permanent</option>
      </select>
      <div>
        <button onclick="confirmMute()">🔇 Mute</button>
        <button onclick="unmuteUser()">🔊 Démute</button>
        <button onclick="closeModal()">❌ Annuler</button>
      </div>
    </div>
  </div>

  <div id="edit-modal" class="modal hidden">
    <div class="modal-content">
      <h3>✏️ Modifier</h3>
      <textarea id="edit-text" rows="4" style="width:100%;"></textarea>
      <div>
        <button onclick="confirmEdit()">✅ Sauver</button>
        <button onclick="closeModal()">❌ Annuler</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBhyxeEHBKrhuECJKt2d7NwSN7lcv39IX0",
      authDomain: "frieren-2-79e0c.firebaseapp.com",
      projectId: "frieren-2-79e0c",
      storageBucket: "frieren-2-79e0c.firebasestorage.app",
      messagingSenderId: "861104473745",
      appId: "1:861104473745:web:377da7b0daaf5570572130"
    };

    const ADMIN_UID = '5yv18zQAJBZZUIwKbFiURFQeFit2';
    let currentUser = null, isAdmin = false, messagesListener = null, usersListener = null;
    let currentMuteTarget = null, currentEditId = null;
    let app, auth, db, storage;

    const $ = id => document.getElementById(id);

    async function init() {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
        
        console.log('Firebase initialized successfully');
        console.log('Storage bucket:', storage.app.options.storageBucket);
        
        onAuthStateChanged(auth, async (user) => {
          $('loading').classList.add('hidden');
          $('app').classList.remove('hidden');
          
          if (user) {
            currentUser = user;
            isAdmin = user.uid === ADMIN_UID;
            await handleLogin(user);
          } else {
            currentUser = null;
            isAdmin = false;
            handleLogout();
          }
        });

        setupForms();
      } catch (error) {
        console.error('Init error:', error);
        $('loading').innerHTML = '❌ Erreur: ' + error.message;
      }
    }

    async function handleLogin(user) {
      $('auth-nav').classList.add('hidden');
      $('logout-nav').classList.remove('hidden');
      $('chat-nav').classList.remove('hidden');
      $('user-info').classList.remove('hidden');
      
      if (isAdmin) $('admin-nav').classList.remove('hidden');
      
      const name = user.displayName || user.email.split('@')[0];
      $('welcome-msg').textContent = `🌟 ${name}${isAdmin ? ' 👑' : ''} - Connecté !`;
      
      await setDoc(doc(db, 'users', user.uid), {
        username: name,
        status: 'online',
        lastSeen: serverTimestamp(),
        isAdmin
      }, { merge: true });
      
      setupChat();
      setupUsers();
    }

    function handleLogout() {
      $('auth-nav').classList.remove('hidden');
      $('logout-nav').classList.add('hidden');
      $('chat-nav').classList.add('hidden');
      $('admin-nav').classList.add('hidden');
      $('user-info').classList.add('hidden');
      
      if (messagesListener) messagesListener();
      if (usersListener) usersListener();
      show('home');
    }

    function setupForms() {
      $('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = $('register-username').value.trim();
        const email = $('register-email').value.trim();
        const password = $('register-password').value;
        
        try {
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          await updateProfile(cred.user, { displayName: username });
          show('home');
          showSuccess('Inscription réussie !');
        } catch (error) {
          showError('Erreur: ' + error.message);
        }
      });

      $('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = $('login-email').value.trim();
        const password = $('login-password').value;
        
        try {
          await signInWithEmailAndPassword(auth, email, password);
          show('home');
          showSuccess('Connexion réussie !');
        } catch (error) {
          showError('Erreur: ' + error.message);
        }
      });
    }

    function setupChat() {
      const q = query(collection(db, 'messages'), orderBy('timestamp', 'desc'), limit(100));

      messagesListener = onSnapshot(q, (snap) => {
        const msgs = $('messages');
        msgs.innerHTML = '';
        const messages = [];
        
        snap.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
        messages.reverse().forEach(addMessage);
        msgs.scrollTop = msgs.scrollHeight;
      });

      $('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      $('image-input').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          console.log('Files selected:', e.target.files.length);
          sendImages(Array.from(e.target.files));
        }
      });
    }

    function setupUsers() {
      usersListener = onSnapshot(collection(db, 'users'), (snap) => {
        const list = $('users-list');
        list.innerHTML = '';
        const users = [];
        
        snap.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
        users.sort((a, b) => {
          if (a.status !== b.status) return a.status === 'online' ? -1 : 1;
          return (a.username || '').localeCompare(b.username || '');
        });
        
        users.forEach(user => {
          const div = document.createElement('div');
          div.className = `user-item ${user.status || 'offline'}`;
          div.innerHTML = `
            <span>${user.username || 'Anonyme'}${user.isAdmin ? ' 👑' : ''}</span>
            <span style="font-size:10px;background:${user.status === 'online' ? '#0f0' : '#666'};color:${user.status === 'online' ? '#000' : '#fff'};padding:2px 6px;border-radius:10px;">${user.status === 'online' ? 'En ligne' : 'Hors ligne'}</span>
          `;
          list.appendChild(div);
        });
      });
    }

    function addMessage(msg) {
      const div = document.createElement('div');
      div.className = 'message';
      
      const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'}) : 'Now';
      const canEdit = currentUser && (msg.userId === currentUser.uid || isAdmin);
      
      let content = `
        <div style="float:right;font-size:12px;color:#666;">${time}</div>
        <div class="username ${msg.isAdmin ? 'admin' : ''}">${msg.username}:</div>
      `;
      
      if (msg.type === 'image' && msg.imageUrl) {
        content += `<img src="${msg.imageUrl}" alt="${msg.fileName || 'Image'}" onclick="window.open('${msg.imageUrl}','_blank')" onerror="this.style.display='none'; console.error('Image failed to load:', '${msg.imageUrl}')">`;
        if (msg.fileName) {
          content += `<div style="font-size:12px;color:#666;margin-top:5px;">📎 ${msg.fileName}</div>`;
        }
      } else if (msg.text) {
        content += `<div>${msg.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>`;
      }

      if (canEdit) {
        content += `<div class="actions">`;
        if (msg.type === 'text') content += `<button onclick="editMessage('${msg.id}')" style="background:#fdcb6e;">✏️</button>`;
        content += `<button onclick="deleteMessage('${msg.id}')" style="background:#d63031;">🗑️</button></div>`;
      }
      
      div.innerHTML = content;
      $('messages').appendChild(div);
    }

    async function sendMessage() {
      if (!currentUser) return;
      
      const input = $('message-input');
      const text = input.value.trim();
      if (!text) return;

      // Check mute
      const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
      if (userDoc.exists() && userDoc.data().mutedUntil) {
        const muteEnd = userDoc.data().mutedUntil.toDate();
        if (muteEnd > new Date()) {
          showError(`Vous êtes mute jusqu'à ${muteEnd.toLocaleString()}`);
          return;
        }
      }
      
      try {
        await addDoc(collection(db, 'messages'), {
          text,
          username: currentUser.displayName || currentUser.email.split('@')[0],
          userId: currentUser.uid,
          timestamp: serverTimestamp(),
          type: 'text',
          isAdmin
        });
        input.value = '';
      } catch (error) {
        console.error('Error sending message:', error);
        showError('Erreur envoi: ' + error.message);
      }
    }

    async function sendImages(files) {
      if (!currentUser) {
        showError('Vous devez être connecté pour envoyer des images');
        return;
      }

      console.log('Attempting to send', files.length, 'images');

      // Check mute
      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.exists() && userDoc.data().mutedUntil) {
          const muteEnd = userDoc.data().mutedUntil.toDate();
          if (muteEnd > new Date()) {
            showError(`Vous êtes mute jusqu'à ${muteEnd.toLocaleString()}`);
            return;
          }
        }
      } catch (error) {
        console.error('Error checking mute status:', error);
      }
      
      for (const file of files) {
        console.log('Processing file:', file.name, 'Size:', file.size, 'Type:', file.type);
        
        if (file.size > 5 * 1024 * 1024) {
          showError(`${file.name} trop lourd (max 5MB)`);
          continue;
        }
        
        if (!file.type.startsWith('image/')) {
          showError(`${file.name} n'est pas une image valide`);
          continue;
        }
        
        try {
          // Create unique filename
          const timestamp = Date.now();
          const randomId = Math.random().toString(36).substr(2, 9);
          const fileExtension = file.name.split('.').pop();
          const fileName = `${timestamp}_${randomId}.${fileExtension}`;
          const path = `images/${currentUser.uid}/${fileName}`;
          
          console.log('Uploading to path:', path);
          
          // Upload to Firebase Storage
          const storageRef = ref(storage, path);
          const snapshot = await uploadBytes(storageRef, file);
          console.log('Upload successful, snapshot:', snapshot);
          
          // Get download URL
          const url = await getDownloadURL(snapshot.ref);
          console.log('Download URL obtained:', url);
          
          // Save message to Firestore
          const messageData = {
            imageUrl: url,
            fileName: file.name,
            fileType: file.type,
            storagePath: path,
            username: currentUser.displayName || currentUser.email.split('@')[0],
            userId: currentUser.uid,
            timestamp: serverTimestamp(),
            type: 'image',
            isAdmin
          };
          
          console.log('Saving message to Firestore:', messageData);
          
          await addDoc(collection(db, 'messages'), messageData);
          console.log('Message saved successfully');
          
        } catch (error) {
          console.error('Detailed error uploading image:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);
          showError(`Erreur upload ${file.name}: ${error.message}`);
        }
      }
      
      $('image-input').value = '';
      showSuccess('Images traitées !');
    }

    async function deleteMessage(id) {
      if (!confirm('Supprimer ce message ?')) return;
      try {
        await deleteDoc(doc(db, 'messages', id));
        showSuccess('Message supprimé');
      } catch (error) {
        console.error('Error deleting message:', error);
        showError('Erreur suppression: ' + error.message);
      }
    }

    async function editMessage(id) {
      try {
        const msgDoc = await getDoc(doc(db, 'messages', id));
        if (msgDoc.exists()) {
          currentEditId = id;
          $('edit-text').value = msgDoc.data().text || '';
          $('edit-modal').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error editing message:', error);
        showError('Erreur: ' + error.message);
      }
    }

    async function confirmEdit() {
      if (!currentEditId) return;
      const newText = $('edit-text').value.trim();
      if (!newText) return showError('Texte vide');
      
      try {
        await updateDoc(doc(db, 'messages', currentEditId), {
          text: newText,
          editedAt: serverTimestamp()
        });
        closeModal();
        showSuccess('Message modifié');
      } catch (error) {
        console.error('Error updating message:', error);
        showError('Erreur: ' + error.message);
      }
    }

    async function clearAllMessages() {
      if (!isAdmin || !confirm('Vider tout le chat ?')) return;
      try {
        const snap = await getDocs(collection(db, 'messages'));
        await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
        showSuccess('Chat vidé');
      } catch (error) {
        console.error('Error clearing messages:', error);
        showError('Erreur: ' + error.message);
      }
    }

    async function showUserManagement() {
      const snap = await getDocs(collection(db, 'users'));
      const list = $('users-management-list');
      list.innerHTML = '';
      
      snap.forEach(doc => {
        const user = doc.data();
        const isMuted = user.mutedUntil && user.mutedUntil.toDate() > new Date();
        const muteText = isMuted ? ` (Mute jusqu'à ${user.mutedUntil.toDate().toLocaleString()})` : '';
        
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
          <div style="flex-grow:1;">
            <strong>${user.username || 'Anonyme'}${user.isAdmin ? ' 👑' : ''}</strong>
            <br><small>${doc.id}</small>
            <span style="color:red;">${muteText}</span>
          </div>
          <button onclick="openMute('${doc.id}', '${user.username || 'Anonyme'}')">${isMuted ? '🔊 Gérer' : '🔇 Mute'}</button>
        `;
        list.appendChild(div);
      });
      
      show('user-management');
    }

    function openMute(userId, username) {
      if (userId === ADMIN_UID) return showError('Impossible de mute un admin');
      currentMuteTarget = userId;
      $('mute-user-info').textContent = `Utilisateur: ${username}`;
      $('mute-reason').value = '';
      $('mute-modal').classList.remove('hidden');
    }

    async function confirmMute() {
      if (!currentMuteTarget) return;
      
      const duration = $('mute-duration').value;
      const reason = $('mute-reason').value || 'Aucune raison';
      
      let muteUntil;
      if (duration === 'permanent') {
        muteUntil = new Date(Date.now() + 100 * 365 * 24 * 60 * 60 * 1000);
      } else {
        muteUntil = new Date(Date.now() + parseInt(duration) * 1000);
      }
      
      try {
        await updateDoc(doc(db, 'users', currentMuteTarget), {
          mutedUntil: muteUntil,
          muteReason: reason,
          mutedBy: currentUser.uid
        });
        closeModal();
        showSuccess('Utilisateur mute');
        showUserManagement();
      } catch (error) {
        console.error('Error muting user:', error);
        showError('Erreur mute: ' + error.message);
      }
    }

    async function unmuteUser() {
      if (!currentMuteTarget) return;
      try {
        await updateDoc(doc(db, 'users', currentMuteTarget), {
          mutedUntil: null,
          muteReason: null,
          mutedBy: null
        });
        closeModal();
        showSuccess('Utilisateur démute');
        showUserManagement();
      } catch (error) {
        console.error('Error unmuting user:', error);
        showError('Erreur: ' + error.message);
      }
    }

    function closeModal() {
      document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
      currentMuteTarget = null;
      currentEditId = null;
    }

    function show(section) {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
      $(section).classList.add('active');
    }

    async function logout() {
      if (currentUser) {
        await setDoc(doc(db, 'users', currentUser.uid), { status: 'offline' }, { merge: true });
      }
      await signOut(auth);
      showSuccess('Déconnecté');
    }

    function showError(msg) {
      console.error('Error:', msg);
      const err = $('auth-error');
      err.textContent = msg;
      err.classList.remove('hidden');
      setTimeout(() => err.classList.add('hidden'), 5000);
    }

    function showSuccess(msg) {
      console.log('Success:', msg);
      const div = document.createElement('div');
      div.className = 'success';
      div.textContent = msg;
      div.style.cssText = 'position:fixed;top:20px;right:20px;z-index:10000;';
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // Global functions
    window.show = show;
    window.logout = logout;
    window.sendMessage = sendMessage;
    window.deleteMessage = deleteMessage;
    window.editMessage = editMessage;
    window.confirmEdit = confirmEdit;
    window.clearAllMessages = clearAllMessages;
    window.showUserManagement = showUserManagement;
    window.openMute = openMute;
    window.confirmMute = confirmMute;
    window.unmuteUser = unmuteUser;
    window.closeModal = closeModal;

    // Event listeners
    window.addEventListener('beforeunload', async () => {
      if (currentUser) {
        try {
          await setDoc(doc(db, 'users', currentUser.uid), { status: 'offline' }, { merge: true });
        } catch (error) {
          console.error('Error setting offline status:', error);
        }
      }
    });

    document.addEventListener('visibilitychange', async () => {
      if (currentUser) {
        try {
          const status = document.hidden ? 'offline' : 'online';
          await setDoc(doc(db, 'users', currentUser.uid), { status }, { merge: true });
        } catch (error) {
          console.error('Error updating visibility status:', error);
        }
      }
    });

    init();
  </script>
</body>
</html>


