<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>L'Ordre de Frieren & J√§germeister</title>
  <style>
    * { box-sizing: border-box; }
    
    body{
      background:linear-gradient(90deg, magenta, lime, cyan, yellow);
      font-family:"Comic Sans MS", "Papyrus", cursive;
      color:#0000ff;
      margin:0;
      padding:0;
      text-align:center;
    }
    header{
      background:repeating-linear-gradient(45deg, red, red 10px, blue 10px, blue 20px);
      color:#00ff00;
      padding:20px;
      border:5px dotted orange;
    }
    h1{
      font-size:48px;
      text-shadow:3px 3px yellow;
      transform:skewX(-10deg);
    }
    nav a{
      margin:0 10px;
      color:#ff00ff;
      font-size:22px;
      background:#00ffff;
      padding:5px 10px;
      border:3px dashed purple;
      cursor:pointer;
      text-decoration:none;
    }
    nav a:hover{
      background:#ffff00;
      transform:scale(1.1);
    }
    .card{
      margin:20px;
      padding:20px;
      border:7px ridge pink;
      background:linear-gradient(45deg, #ff6600, #00ffcc, #ff00ff);
      font-size:20px;
      display:none;
    }
    .card.active{
      display:block;
    }
    img.frieren{
      border:10px groove lime;
      max-width:300px;
      display:block;
      margin:20px auto;
    }
    form{
      background:linear-gradient(90deg, pink, violet, turquoise);
      padding:20px;
      border:6px dotted red;
      margin:20px auto;
      width:60%;
      max-width:500px;
    }
    input, textarea, select{
      display:block;
      width:80%;
      margin:10px auto;
      padding:10px;
      font-family:"Comic Sans MS", cursive;
      border:5px inset yellow;
      background:#ffeb3b;
    }
    button{
      background:lime;
      font-size:24px;
      border:4px outset cyan;
      padding:10px 20px;
      cursor:pointer;
      font-family:"Impact", fantasy;
      margin:5px;
    }
    button:hover{
      background:#00ff00;
      transform:scale(1.05);
    }
    button:disabled{
      background:#ccc;
      cursor:not-allowed;
    }
    .auth-container{
      display:flex;
      justify-content:center;
      gap:20px;
      flex-wrap:wrap;
    }
    .auth-form{
      width:300px;
    }
    .chat-layout{
      display:flex;
      max-width:1200px;
      margin:0 auto;
      gap:20px;
    }
    #chat-container{
      flex:1;
      max-width:800px;
    }
    #online-users{
      width:250px;
      background:rgba(255,255,255,0.3);
      border:5px groove lime;
      padding:15px;
      border-radius:15px;
      height:500px;
      overflow-y:auto;
    }
    #messages{
      height:400px;
      overflow-y:auto;
      background:rgba(255,255,255,0.2);
      border:5px groove lime;
      padding:10px;
      margin:20px 0;
      text-align:left;
    }
    .message{
      background:rgba(0,255,255,0.3);
      margin:5px 0;
      padding:10px;
      border:2px solid purple;
      border-radius:10px;
      position:relative;
    }
    .message.muted{
      background:rgba(128,128,128,0.5);
    }
    .message img{
      max-width:300px;
      max-height:300px;
      border:3px solid lime;
      border-radius:10px;
      cursor:pointer;
      margin:5px 0;
    }
    .message .username{
      font-weight:bold;
      color:#ff00ff;
    }
    .message .username.admin{
      color:#ff0000;
    }
    .message .username.admin::after{
      content:" üëë";
    }
    .message .timestamp{
      font-size:12px;
      color:#666;
      float:right;
    }
    .message .actions{
      margin-top:5px;
    }
    .message .edit-btn, .message .delete-btn, .message .admin-btn{
      font-size:12px;
      padding:3px 8px;
      margin:2px;
    }
    .message .edit-btn{
      background:#fdcb6e;
    }
    .message .delete-btn{
      background:#d63031;
    }
    .message .admin-btn{
      background:#e17055;
    }
    #message-input{
      width:50%;
      display:inline-block;
    }
    #send-btn{
      width:20%;
      display:inline-block;
      font-size:18px;
    }
    .image-btn{
      width:20%;
      display:inline-block;
      font-size:18px;
      background:#ff69b4;
    }
    .user-info{
      background:rgba(255,255,255,0.3);
      padding:15px;
      margin:20px auto;
      border:3px solid orange;
      border-radius:15px;
      max-width:400px;
    }
    .admin-panel{
      background:rgba(255,0,0,0.2);
      border:5px solid red;
      padding:15px;
      margin:20px;
      border-radius:15px;
    }
    .user-item{
      background:rgba(255,255,255,0.4);
      margin:5px 0;
      padding:8px;
      border-radius:8px;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .user-item.online{
      border-left:5px solid #00ff00;
    }
    .user-item.offline{
      border-left:5px solid #666;
      opacity:0.7;
    }
    .user-item.muted{
      background:rgba(255,0,0,0.2);
      border-left:5px solid #ff0000;
    }
    .user-status{
      font-size:10px;
      padding:2px 6px;
      border-radius:10px;
      margin-left:5px;
    }
    .status-online{
      background:#00ff00;
      color:#000;
    }
    .status-offline{
      background:#666;
      color:#fff;
    }
    .status-muted{
      background:#ff0000;
      color:#fff;
    }
    .hidden{
      display:none !important;
    }
    footer{
      background:#ff00ff;
      color:#00ffff;
      font-size:18px;
      padding:20px;
      border-top:8px double black;
    }
    .loading{
      color:#fff;
      font-size:18px;
      margin:20px;
    }
    .error{
      background:red;
      color:white;
      padding:10px;
      margin:10px;
      border-radius:5px;
    }
    .success{
      background:green;
      color:white;
      padding:10px;
      margin:10px;
      border-radius:5px;
    }
    .modal{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.8);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    .modal-content{
      background:linear-gradient(45deg, #ff6600, #00ffcc, #ff00ff);
      padding:30px;
      border:5px solid lime;
      border-radius:20px;
      max-width:500px;
      width:90%;
    }
    .modal-content input, .modal-content select{
      width:100%;
      margin:10px 0;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">üî• Initialisation de la connexion cosmique... üî•</div>
  
  <div id="app" class="hidden">
    <header>
      <h1>üî• L'Ordre Sacr√© de Frieren & J√§germeister üî•</h1>
      <nav>
        <a href="#" onclick="showSection('home')">Accueil</a>
        <a href="#" onclick="showSection('creed')">Pr√©ceptes</a>
        <a href="#" onclick="showSection('rituals')">Rituels</a>
        <a href="#" onclick="showSection('offerings')">Offrandes</a>
        <a href="#" onclick="showSection('chat')" id="chat-nav" class="hidden">Chat Sacr√©</a>
        <a href="#" onclick="showSection('admin')" id="admin-nav" class="hidden">Admin üëë</a>
        <a href="#" onclick="showSection('auth')" id="auth-nav">Connexion</a>
        <a href="#" onclick="logout()" id="logout-nav" class="hidden">D√©connexion</a>
      </nav>
      
      <div id="user-info" class="user-info hidden">
        <span id="welcome-msg">Bienvenue, disciple cosmique !</span>
      </div>
    </header>

    <main>
      <!-- Accueil -->
      <div id="home" class="card active">
        <h2>Bienvenue Voyageur Cosmique ‚ú®</h2>
        <p>Ici on m√©lange la sagesse √©ternelle de Frieren et la puissance mystique de la J√§germeister. Rien n'a de sens, et c'est mieux comme √ßa.</p>
        <img class="frieren" src="https://pbs.twimg.com/media/GBh8vx-awAA1n-L.jpg" alt="Frieren divine">
      </div>

      <!-- Pr√©ceptes -->
      <div id="creed" class="card">
        <h3>üìú Pr√©ceptes sacr√©s (bizarres)</h3>
        <ul>
          <li>Ne bois que quand tu oublies pourquoi tu bois.</li>
          <li>Frieren est la seule r√©ponse, m√™me quand ce n'est pas une question.</li>
          <li>Le vert fluo est la couleur de la v√©rit√©.</li>
        </ul>
      </div>

      <!-- Rituels -->
      <div id="rituals" class="card">
        <h3>üîÆ Rituels sacr√©s</h3>
        <p>On danse autour d'un frigo vide, on r√©cite des citations invent√©es et on crie ¬´ POUR FRIEREN ¬ª en levant un verre de J√§germeister ti√®de.</p>
      </div>

      <!-- Offrandes -->
      <div id="offerings" class="card">
        <h3>üçπ Offrandes sacr√©es</h3>
        <p>Soupe de chips mix√©s + J√§germeister + gla√ßons fluorescents.</p>
        <p>Smoothie banane-fraises‚Ä¶ remplac√©es par plus de J√§germeister.</p>
      </div>

      <!-- Authentification -->
      <div id="auth" class="card">
        <h3>üîê Rejoindre la secte cosmique</h3>
        <div class="auth-container">
          <!-- Inscription -->
          <div class="auth-form">
            <h4>üìù Cr√©er un compte</h4>
            <form id="register-form">
              <input type="text" id="register-username" placeholder="Nom cosmique" required>
              <input type="email" id="register-email" placeholder="Email du futur" required>
              <input type="password" id="register-password" placeholder="Mot de passe mystique" required>
              <button type="submit">üåü Rejoindre l'Ordre</button>
            </form>
          </div>

          <!-- Connexion -->
          <div class="auth-form">
            <h4>üö™ Se connecter</h4>
            <form id="login-form">
              <input type="email" id="login-email" placeholder="Email" required>
              <input type="password" id="login-password" placeholder="Mot de passe" required>
              <button type="submit">‚ö° Connexion cosmique</button>
            </form>
          </div>
        </div>
        <div id="auth-error" class="error hidden"></div>
      </div>

      <!-- Admin Panel -->
      <div id="admin" class="card">
        <div class="admin-panel">
          <h3>üëë Panel Administrateur Cosmique</h3>
          <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <button onclick="showUserManagement()">üë• Gestion Utilisateurs</button>
            <button onclick="clearAllMessages()">üóëÔ∏è Vider le Chat</button>
            <button onclick="exportData()">üìä Export Donn√©es</button>
          </div>
          <div id="admin-status" class="success hidden"></div>
        </div>
      </div>

      <!-- Chat -->
      <div id="chat" class="card">
        <h3>üí¨ Chat Sacr√© de l'Ordre</h3>
        <div class="chat-layout">
          <div id="chat-container">
            <div id="messages"></div>
            <div>
              <input type="text" id="message-input" placeholder="Partage ta sagesse cosmique..." maxlength="2000">
              <input type="file" id="image-input" accept="image/*,.gif" style="display:none;" multiple>
              <button class="image-btn" onclick="document.getElementById('image-input').click()">üì∑</button>
              <button id="send-btn" onclick="sendMessage()">üöÄ</button>
            </div>
          </div>
          
          <!-- Liste des utilisateurs en ligne -->
          <div id="online-users">
            <h4 style="margin-top:0; color:#ff00ff;">üë• Disciples Connect√©s</h4>
            <div id="users-list"></div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>¬© 1987-2025 ‚Äî L'Ordre de Frieren & J√§germeister. Site moche garanti.</p>
    </footer>
  </div>

  <!-- Modals -->
  <div id="user-management-modal" class="modal hidden">
    <div class="modal-content">
      <h3>üë• Gestion des Utilisateurs</h3>
      <div id="users-management-list"></div>
      <button onclick="closeModal()">Fermer</button>
    </div>
  </div>

  <div id="mute-modal" class="modal hidden">
    <div class="modal-content">
      <h3>üîá Muter un Utilisateur</h3>
      <input type="text" id="mute-reason" placeholder="Raison du mute">
      <select id="mute-duration">
        <option value="300">5 minutes</option>
        <option value="1800">30 minutes</option>
        <option value="3600">1 heure</option>
        <option value="86400">24 heures</option>
        <option value="604800">7 jours</option>
        <option value="2592000">30 jours</option>
        <option value="permanent">Permanent</option>
      </select>
      <div style="margin-top:15px;">
        <button onclick="confirmMute()">Confirmer Mute</button>
        <button onclick="closeModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile,
      deleteUser
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp,
      limit,
      doc,
      updateDoc,
      deleteDoc,
      setDoc,
      getDoc,
      getDocs,
      where
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
      deleteObject
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBhyxeEHBKrhuECJKt2d7NwSN7lcv39IX0",
      authDomain: "frieren-2-79e0c.firebaseapp.com",
      projectId: "frieren-2-79e0c",
      storageBucket: "frieren-2-79e0c.firebasestorage.app",
      messagingSenderId: "861104473745",
      appId: "1:861104473745:web:377da7b0daaf5570572130"
    };

    // Variables globales
    const ADMIN_UID = '5yv18zQAJBZZUIwKbFiURFQeFit2';
    let currentUser = null;
    let isAdmin = false;
    let messagesListener = null;
    let usersListener = null;
    let currentMuteTarget = null;
    let app, auth, db, storage;

    // √âl√©ments DOM
    const loadingDiv = document.getElementById('loading');
    const appDiv = document.getElementById('app');
    const authNav = document.getElementById('auth-nav');
    const logoutNav = document.getElementById('logout-nav');
    const chatNav = document.getElementById('chat-nav');
    const adminNav = document.getElementById('admin-nav');
    const userInfo = document.getElementById('user-info');
    const welcomeMsg = document.getElementById('welcome-msg');
    const authError = document.getElementById('auth-error');

    // Initialisation Firebase
    async function initFirebase() {
      try {
        console.log('üî• Initialisation Firebase...');
        
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
        
        console.log('‚úÖ Firebase initialis√©');
        
        onAuthStateChanged(auth, async (user) => {
          console.log('üë§ Auth √©tat:', user ? user.email : 'D√©connect√©');
          
          loadingDiv.classList.add('hidden');
          appDiv.classList.remove('hidden');
          
          if (user) {
            currentUser = user;
            isAdmin = user.uid === ADMIN_UID;
            await handleUserLoggedIn(user);
          } else {
            currentUser = null;
            isAdmin = false;
            handleUserLoggedOut();
          }
        });

        setupAuthForms();
        
      } catch (error) {
        console.error('‚ùå Erreur Firebase:', error);
        loadingDiv.innerHTML = '‚ùå Erreur: ' + error.message;
      }
    }

    async function handleUserLoggedIn(user) {
      authNav.classList.add('hidden');
      logoutNav.classList.remove('hidden');
      chatNav.classList.remove('hidden');
      userInfo.classList.remove('hidden');
      
      if (isAdmin) {
        adminNav.classList.remove('hidden');
      }
      
      const displayName = user.displayName || user.email.split('@')[0];
      welcomeMsg.textContent = `üåü ${displayName}${isAdmin ? ' üëë' : ''} - Connect√© !`;
      
      // Mettre √† jour le statut utilisateur
      await updateUserStatus(user.uid, displayName, 'online');
      
      setupChatListener();
      setupUsersListener();
      
      // V√©rifier si l'utilisateur est muted
      await checkUserMuteStatus();
    }

    function handleUserLoggedOut() {
      authNav.classList.remove('hidden');
      logoutNav.classList.add('hidden');
      chatNav.classList.add('hidden');
      adminNav.classList.add('hidden');
      userInfo.classList.add('hidden');
      
      if (messagesListener) {
        messagesListener();
        messagesListener = null;
      }
      
      if (usersListener) {
        usersListener();
        usersListener = null;
      }
      
      showSection('home');
    }

    async function updateUserStatus(userId, username, status) {
      try {
        await setDoc(doc(db, 'users', userId), {
          username,
          status,
          lastSeen: serverTimestamp(),
          isAdmin: userId === ADMIN_UID
        }, { merge: true });
      } catch (error) {
        console.error('Erreur update status:', error);
      }
    }

    async function checkUserMuteStatus() {
      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          if (data.mutedUntil) {
            const muteEnd = new Date(data.mutedUntil.seconds * 1000);
            if (muteEnd > new Date()) {
              showError(`Vous √™tes mute jusqu'√† ${muteEnd.toLocaleString()}`);
              document.getElementById('message-input').disabled = true;
              document.getElementById('send-btn').disabled = true;
            }
          }
        }
      } catch (error) {
        console.error('Erreur check mute:', error);
      }
    }

    function setupAuthForms() {
      document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        
        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          await updateProfile(userCredential.user, { displayName: username });
          showSection('home');
        } catch (error) {
          showError('Erreur inscription: ' + error.message);
        }
      });

      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        try {
          await signInWithEmailAndPassword(auth, email, password);
          showSection('home');
        } catch (error) {
          showError('Erreur connexion: ' + error.message);
        }
      });
    }

    function setupChatListener() {
      const messagesDiv = document.getElementById('messages');
      const q = query(
        collection(db, 'messages'),
        orderBy('timestamp', 'desc'),
        limit(100)
      );

      messagesListener = onSnapshot(q, (snapshot) => {
        messagesDiv.innerHTML = '';
        const messages = [];
        
        snapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });
        
        messages.reverse().forEach((message) => {
          addMessageToDOM(message);
        });
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      document.getElementById('image-input').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
          sendImageMessages(files);
        }
      });
    }

    function setupUsersListener() {
      const usersListDiv = document.getElementById('users-list');
      
      usersListener = onSnapshot(collection(db, 'users'), (snapshot) => {
        usersListDiv.innerHTML = '';
        const users = [];
        
        snapshot.forEach((doc) => {
          users.push({ id: doc.id, ...doc.data() });
        });
        
        // Trier par statut (online en premier) puis par nom
        users.sort((a, b) => {
          if (a.status !== b.status) {
            return a.status === 'online' ? -1 : 1;
          }
          return (a.username || '').localeCompare(b.username || '');
        });
        
        users.forEach((user) => {
          addUserToList(user);
        });
      });
    }

    function addUserToList(user) {
      const usersListDiv = document.getElementById('users-list');
      const userDiv = document.createElement('div');
      userDiv.className = `user-item ${user.status || 'offline'} ${user.mutedUntil ? 'muted' : ''}`;
      
      const statusText = user.status === 'online' ? 'En ligne' : 'Hors ligne';
      const muteText = user.mutedUntil ? ' (Mute)' : '';
      
      userDiv.innerHTML = `
        <span>${user.username || 'Anonyme'}${user.isAdmin ? ' üëë' : ''}${muteText}</span>
        <span class="user-status status-${user.status || 'offline'}">${statusText}</span>
      `;
      
      usersListDiv.appendChild(userDiv);
    }

    async function sendMessage() {
      if (!currentUser) return;
      
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // V√©rifier si l'utilisateur est mute
      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          if (data.mutedUntil) {
            const muteEnd = new Date(data.mutedUntil.seconds * 1000);
            if (muteEnd > new Date()) {
              showError(`Vous √™tes mute jusqu'√† ${muteEnd.toLocaleString()}`);
              return;
            }
          }
        }
      } catch (error) {
        console.error('Erreur check mute:', error);
      }
      
      try {
        await addDoc(collection(db, 'messages'), {
          text: message,
          username: currentUser.displayName || currentUser.email.split('@')[0],
          userId: currentUser.uid,
          timestamp: serverTimestamp(),
          type: 'text',
          isAdmin: isAdmin
        });
        
        input.value = '';
      } catch (error) {
        showError('Erreur envoi: ' + error.message);
      }
    }

    async function sendImageMessages(files) {
      if (!currentUser) return;
      
      try {
        for (const file of files) {
          if (file.size > 50 * 1024 * 1024) {
            showError(`Fichier ${file.name} trop lourd (max 50MB)`);
            continue;
          }
          
          console.log('üì§ Upload image...');
          
          const fileName = `images/${Date.now()}_${file.name}`;
          const imageRef = ref(storage, fileName);
          
          const snapshot = await uploadBytes(imageRef, file);
          const downloadURL = await getDownloadURL(snapshot.ref);
          
          await addDoc(collection(db, 'messages'), {
            imageUrl: downloadURL,
            fileName: file.name,
            fileType: file.type,
            storagePath: fileName,
            username: currentUser.displayName || currentUser.email.split('@')[0],
            userId: currentUser.uid,
            timestamp: serverTimestamp(),
            type: 'image',
            isAdmin: isAdmin
          });
        }
        
        document.getElementById('image-input').value = '';
        console.log('‚úÖ Images envoy√©es');
        
      } catch (error) {
        console.error('‚ùå Erreur upload:', error);
        showError('Erreur upload: ' + error.message);
      }
    }

    function addMessageToDOM(message) {
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.setAttribute('data-message-id', message.id);
      
      const timestamp = message.timestamp ? 
        new Date(message.timestamp.seconds * 1000).toLocaleTimeString('fr-FR', {
          hour: '2-digit',
          minute: '2-digit'
        }) : 'Maintenant';
      
      let content = `
        <div class="timestamp">${timestamp}</div>
        <div class="username ${message.isAdmin ? 'admin' : ''}">${message.username}:</div>
      `;
      
      if (message.type === 'image' && message.imageUrl) {
        const isGif = message.fileType === 'image/gif';
        content += `
          <div>
            <img src="${message.imageUrl}" 
                 alt="${message.fileName || 'Image'}" 
                 onclick="openImageModal('${message.imageUrl}', '${message.fileName || 'Image'}')">
            <br><small style="color:#666
