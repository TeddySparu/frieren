<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>L'Ordre de Frieren & J√§germaister</title>
  <style>
    * { box-sizing: border-box; }
    
    body{
      background:linear-gradient(90deg, magenta, lime, cyan, yellow);
      font-family:"Comic Sans MS", "Papyrus", cursive;
      color:#0000ff;
      margin:0;
      padding:0;
      text-align:center;
    }
    header{
      background:repeating-linear-gradient(45deg, red, red 10px, blue 10px, blue 20px);
      color:#00ff00;
      padding:20px;
      border:5px dotted orange;
    }
    h1{
      font-size:48px;
      text-shadow:3px 3px yellow;
      transform:skewX(-10deg);
    }
    nav a{
      margin:0 10px;
      color:#ff00ff;
      font-size:22px;
      background:#00ffff;
      padding:5px 10px;
      border:3px dashed purple;
      cursor:pointer;
      text-decoration:none;
    }
    nav a:hover{
      background:#ffff00;
      transform:scale(1.1);
    }
    .card{
      margin:20px;
      padding:20px;
      border:7px ridge pink;
      background:linear-gradient(45deg, #ff6600, #00ffcc, #ff00ff);
      font-size:20px;
      display:none;
    }
    .card.active{
      display:block;
    }
    img.frieren{
      border:10px groove lime;
      max-width:300px;
      display:block;
      margin:20px auto;
    }
    form{
      background:linear-gradient(90deg, pink, violet, turquoise);
      padding:20px;
      border:6px dotted red;
      margin:20px auto;
      width:60%;
      max-width:500px;
    }
    input, textarea{
      display:block;
      width:80%;
      margin:10px auto;
      padding:10px;
      font-family:"Comic Sans MS", cursive;
      border:5px inset yellow;
      background:#ffeb3b;
    }
    button{
      background:lime;
      font-size:24px;
      border:4px outset cyan;
      padding:10px 20px;
      cursor:pointer;
      font-family:"Impact", fantasy;
      margin:5px;
    }
    button:hover{
      background:#00ff00;
      transform:scale(1.05);
    }
    button:disabled{
      background:#ccc;
      cursor:not-allowed;
    }
    .auth-container{
      display:flex;
      justify-content:center;
      gap:20px;
      flex-wrap:wrap;
    }
    .auth-form{
      width:300px;
    }
    #chat-container{
      max-width:800px;
      margin:0 auto;
    }
    #messages{
      height:400px;
      overflow-y:auto;
      background:rgba(255,255,255,0.2);
      border:5px groove lime;
      padding:10px;
      margin:20px 0;
      text-align:left;
    }
    .message{
      background:rgba(0,255,255,0.3);
      margin:5px 0;
      padding:10px;
      border:2px solid purple;
      border-radius:10px;
      position:relative;
    }
    .message img{
      max-width:300px;
      max-height:300px;
      border:3px solid lime;
      border-radius:10px;
      cursor:pointer;
      margin:5px 0;
    }
    .message .username{
      font-weight:bold;
      color:#ff00ff;
    }
    .message .timestamp{
      font-size:12px;
      color:#666;
      float:right;
    }
    .message .actions{
      margin-top:5px;
    }
    .message .edit-btn, .message .delete-btn{
      font-size:12px;
      padding:3px 8px;
      margin:2px;
    }
    .message .edit-btn{
      background:#fdcb6e;
    }
    .message .delete-btn{
      background:#d63031;
    }
    #message-input{
      width:50%;
      display:inline-block;
    }
    #send-btn{
      width:20%;
      display:inline-block;
      font-size:18px;
    }
    .image-btn{
      width:20%;
      display:inline-block;
      font-size:18px;
      background:#ff69b4;
    }
    .user-info{
      background:rgba(255,255,255,0.3);
      padding:15px;
      margin:20px auto;
      border:3px solid orange;
      border-radius:15px;
      max-width:400px;
    }
    .hidden{
      display:none !important;
    }
    footer{
      background:#ff00ff;
      color:#00ffff;
      font-size:18px;
      padding:20px;
      border-top:8px double black;
    }
    .loading{
      color:#fff;
      font-size:18px;
      margin:20px;
    }
    .error{
      background:red;
      color:white;
      padding:10px;
      margin:10px;
      border-radius:5px;
    }
    .upload-status{
      background:#74b9ff;
      color:white;
      padding:10px;
      margin:10px;
      border-radius:5px;
      font-size:14px;
    }
    .imgur-info{
      background:rgba(116, 185, 255, 0.2);
      border:3px solid #74b9ff;
      padding:15px;
      margin:15px;
      border-radius:10px;
      font-size:14px;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">üî• Initialisation de la connexion cosmique... üî•</div>
  
  <div id="app" class="hidden">
    <header>
      <h1>üî• L'Ordre Sacr√© de Frieren & J√§germaister üî•</h1>
      <nav>
        <a href="#" onclick="showSection('home')">Accueil</a>
        <a href="#" onclick="showSection('creed')">Pr√©ceptes</a>
        <a href="#" onclick="showSection('rituals')">Rituels</a>
        <a href="#" onclick="showSection('offerings')">Offrandes</a>
        <a href="#" onclick="showSection('chat')" id="chat-nav" class="hidden">Chat Sacr√©</a>
        <a href="#" onclick="showSection('auth')" id="auth-nav">Connexion</a>
        <a href="#" onclick="logout()" id="logout-nav" class="hidden">D√©connexion</a>
      </nav>
      
      <div id="user-info" class="user-info hidden">
        <span id="welcome-msg">Bienvenue, disciple cosmique !</span>
      </div>
    </header>

    <main>
      <!-- Accueil -->
      <div id="home" class="card active">
        <h2>Bienvenue Voyageur Cosmique ‚ú®</h2>
        <p>Ici on m√©lange la sagesse √©ternelle de Frieren et la puissance mystique de la J√§germaister. Rien n'a de sens, et c'est mieux comme √ßa.</p>
        <img class="frieren" src="https://pbs.twimg.com/media/GBh8vx-awAA1n-L.jpg:large" alt="Frieren divine">
        
        <div class="imgur-info">
          <h3>üñºÔ∏è Syst√®me d'images qui fonctionne pas ptn de merde </h3>
          <p> Frieren <strong>DOIT ABSOLUMENT</strong> √™tre v√©n√©r√©e par tous</p>
          <p> Le p√¢pe et le cardinal sont des √™tres <strong>sup√©rieurs</strong></p>
        </div>
      </div>

      <!-- Pr√©ceptes -->
      <div id="creed" class="card">
        <h3>üìú Pr√©ceptes sacr√©s (bizarres)</h3>
        <ul>
          <li>Ne bois que quand tu oublies pourquoi tu bois.</li>
          <li>Frieren est la seule r√©ponse, m√™me quand ce n'est pas une question.</li>
          <li>Le vert fluo est la couleur de la v√©rit√©.</li>
        </ul>
      </div>

      <!-- Rituels -->
      <div id="rituals" class="card">
        <h3>üîÆ Rituels sacr√©s</h3>
        <p>On danse autour d'un frigo vide, on r√©cite des citations invent√©es et on crie ¬´ POUR FRIEREN ¬ª en levant un verre de J√§germaister ti√®de.</p>
      </div>

      <!-- Offrandes -->
      <div id="offerings" class="card">
        <h3>üçπ Offrandes sacr√©es</h3>
        <p>Soupe de chips mix√©s + J√§germaister + gla√ßons fluorescents.</p>
        <p>Smoothie banane-fraises‚Ä¶ remplac√©es par plus de J√§germaister.</p>
      </div>

      <!-- Authentification -->
      <div id="auth" class="card">
        <h3>üîê Rejoindre la secte cosmique</h3>
        <div class="auth-container">
          <!-- Inscription -->
          <div class="auth-form">
            <h4>üìù Cr√©er un compte</h4>
            <form id="register-form">
              <input type="text" id="register-username" placeholder="Nom cosmique" required>
              <input type="email" id="register-email" placeholder="Email du futur" required>
              <input type="password" id="register-password" placeholder="Mot de passe mystique" required>
              <button type="submit">üåü Rejoindre l'Ordre</button>
            </form>
          </div>

          <!-- Connexion -->
          <div class="auth-form">
            <h4>üö™ Se connecter</h4>
            <form id="login-form">
              <input type="email" id="login-email" placeholder="Email" required>
              <input type="password" id="login-password" placeholder="Mot de passe" required>
              <button type="submit">‚ö° Connexion cosmique</button>
            </form>
          </div>
        </div>
        <div id="auth-error" class="error hidden"></div>
      </div>

      <!-- Chat -->
      <div id="chat" class="card">
        <h3>üí¨ Chat Sacr√© de l'Ordre</h3>
        <div id="chat-container">
          <div id="messages"></div>
          <div id="upload-status" class="upload-status hidden"></div>
          <div>
            <input type="text" id="message-input" placeholder="Partage ta sagesse cosmique..." maxlength="2000">
            <input type="file" id="image-input" accept="image/*,.gif" style="display:none;" multiple>
            <button class="image-btn" onclick="document.getElementById('image-input').click()">üì∑</button>
            <button id="send-btn" onclick="sendMessage()">üöÄ</button>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>¬© 1987-2025 ‚Äî L'Ordre de Frieren & J√§germaister. Images par Imgur API üñºÔ∏è</p>
    </footer>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase depuis CDN
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp,
      limit,
      deleteDoc,
      doc,
      updateDoc
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBhyxeEHBKrhuECJKt2d7NwSN7lcv39IX0",
      authDomain: "frieren-2-79e0c.firebaseapp.com",
      projectId: "frieren-2-79e0c",
      storageBucket: "frieren-2-79e0c.firebasestorage.app",
      messagingSenderId: "861104473745",
      appId: "1:861104473745:web:377da7b0daaf5570572130"
    };

    // Cl√© API Imgur (publique, pas de probl√®me de s√©curit√©)
    const IMGUR_CLIENT_ID = 'b59bc82de5c0b96';

    // Variables globales
    let currentUser = null;
    let messagesListener = null;
    let app, auth, db;

    // √âl√©ments DOM
    const loadingDiv = document.getElementById('loading');
    const appDiv = document.getElementById('app');
    const authNav = document.getElementById('auth-nav');
    const logoutNav = document.getElementById('logout-nav');
    const chatNav = document.getElementById('chat-nav');
    const userInfo = document.getElementById('user-info');
    const welcomeMsg = document.getElementById('welcome-msg');
    const authError = document.getElementById('auth-error');
    const uploadStatus = document.getElementById('upload-status');

    // Initialisation Firebase
    async function initFirebase() {
      try {
        console.log('üî• Initialisation Firebase...');
        
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        
        console.log('‚úÖ Firebase initialis√©');
        
        onAuthStateChanged(auth, (user) => {
          console.log('üë§ Auth √©tat:', user ? user.email : 'D√©connect√©');
          
          loadingDiv.classList.add('hidden');
          appDiv.classList.remove('hidden');
          
          if (user) {
            currentUser = user;
            handleUserLoggedIn(user);
          } else {
            currentUser = null;
            handleUserLoggedOut();
          }
        });

        setupAuthForms();
        
      } catch (error) {
        console.error('‚ùå Erreur Firebase:', error);
        loadingDiv.innerHTML = '‚ùå Erreur: ' + error.message;
      }
    }

    function handleUserLoggedIn(user) {
      authNav.classList.add('hidden');
      logoutNav.classList.remove('hidden');
      chatNav.classList.remove('hidden');
      userInfo.classList.remove('hidden');
      
      const displayName = user.displayName || user.email.split('@')[0];
      welcomeMsg.textContent = `üåü ${displayName} - Connect√© !`;
      
      setupChatListener();
    }

    function handleUserLoggedOut() {
      authNav.classList.remove('hidden');
      logoutNav.classList.add('hidden');
      chatNav.classList.add('hidden');
      userInfo.classList.add('hidden');
      
      if (messagesListener) {
        messagesListener();
        messagesListener = null;
      }
      
      showSection('home');
    }

    function setupAuthForms() {
      document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        
        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          await updateProfile(userCredential.user, { displayName: username });
          showSection('home');
        } catch (error) {
          showError('Erreur inscription: ' + error.message);
        }
      });

      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        try {
          await signInWithEmailAndPassword(auth, email, password);
          showSection('home');
        } catch (error) {
          showError('Erreur connexion: ' + error.message);
        }
      });
    }

    function setupChatListener() {
      const messagesDiv = document.getElementById('messages');
      const q = query(
        collection(db, 'messages'),
        orderBy('timestamp', 'desc'),
        limit(50)
      );

      messagesListener = onSnapshot(q, (snapshot) => {
        messagesDiv.innerHTML = '';
        const messages = [];
        
        snapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });
        
        messages.reverse().forEach((message) => {
          addMessageToDOM(message);
        });
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      document.getElementById('image-input').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
          sendImageMessages(files);
        }
      });
    }

    // Upload vers Imgur
    async function uploadToImgur(file) {
      const formData = new FormData();
      formData.append('image', file);
      formData.append('type', 'file');

      try {
        const response = await fetch('https://api.imgur.com/3/image', {
          method: 'POST',
          headers: {
            'Authorization': `Client-ID ${IMGUR_CLIENT_ID}`,
          },
          body: formData
        });

        const data = await response.json();
        
        if (data.success) {
          return {
            url: data.data.link,
            deleteHash: data.data.deletehash
          };
        } else {
          throw new Error(data.data.error || 'Upload Imgur √©chou√©');
        }
      } catch (error) {
        console.error('Erreur upload Imgur:', error);
        throw error;
      }
    }

    async function sendMessage() {
      if (!currentUser) return;
      
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      try {
        await addDoc(collection(db, 'messages'), {
          text: message,
          username: currentUser.displayName || currentUser.email.split('@')[0],
          userId: currentUser.uid,
          timestamp: serverTimestamp(),
          type: 'text'
        });
        
        input.value = '';
      } catch (error) {
        showError('Erreur envoi: ' + error.message);
      }
    }

    async function sendImageMessages(files) {
      if (!currentUser) return;
      
      showUploadStatus(`üì§ Upload de ${files.length} fichier(s)...`);
      
      try {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          // V√©rification taille (20MB max)
          if (file.size > 20 * 1024 * 1024) {
            showError(`Fichier ${file.name} trop lourd (max 20MB)`);
            continue;
          }
          
          showUploadStatus(`üì§ Upload ${i + 1}/${files.length}: ${file.name}...`);
          
          // Upload vers Imgur
          const result = await uploadToImgur(file);
          
          // Sauvegarde en base
          await addDoc(collection(db, 'messages'), {
            imageUrl: result.url,
            imageDeleteHash: result.deleteHash,
            fileName: file.name,
            fileType: file.type,
            fileSize: file.size,
            username: currentUser.displayName || currentUser.email.split('@')[0],
            userId: currentUser.uid,
            timestamp: serverTimestamp(),
            type: 'image'
          });
        }
        
        document.getElementById('image-input').value = '';
        showUploadStatus(`‚úÖ ${files.length} fichier(s) upload√©(s) avec succ√®s !`);
        setTimeout(hideUploadStatus, 3000);
        
      } catch (error) {
        console.error('‚ùå Erreur upload:', error);
        showError('Erreur upload: ' + error.message);
        hideUploadStatus();
      }
    }

    function addMessageToDOM(message) {
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.setAttribute('data-message-id', message.id);
      
      const timestamp = message.timestamp ? 
        new Date(message.timestamp.seconds * 1000).toLocaleTimeString('fr-FR', {
          hour: '2-digit',
          minute: '2-digit'
        }) : 'Maintenant';
      
      let content = `
        <div class="timestamp">${timestamp}</div>
        <div class="username">${message.username}:</div>
      `;
      
      if (message.type === 'image' && message.imageUrl) {
        const isGif = message.fileType === 'image/gif';
        const sizeText = message.fileSize ? `(${(message.fileSize / 1024 / 1024).toFixed(1)}MB)` : '';
        content += `
          <div>
            <img src="${message.imageUrl}" 
                 alt="${message.fileName || 'Image'}" 
                 onclick="openImageModal('${message.imageUrl}', '${message.fileName || 'Image'}')">
            <br><small style="color:#666;">üì∑ ${message.fileName || 'Image'} ${isGif ? '(GIF)' : ''} ${sizeText}</small>
          </div>
        `;
      } else if (message.text) {
        content += `<div>${escapeHtml(message.text)}</div>`;
      }
      
      // Actions pour ses propres messages
      if (currentUser && message.userId === currentUser.uid) {
        content += `
          <div class="actions">
            <button class="delete-btn" onclick="deleteMessage('${message.id}', '${message.imageDeleteHash || ''}')">üóëÔ∏è</button>
            ${message.type === 'text' ? `<button class="edit-btn" onclick="editMessage('${message.id}', '${escapeHtml(message.text || '')}')">‚úèÔ∏è</button>` : ''}
          </div>
        `;
      }
      
      messageDiv.innerHTML = content;
      messagesDiv.appendChild(messageDiv);
    }

    async function deleteMessage(messageId, imageDeleteHash = '') {
      if (!confirm('Supprimer ce message ?')) return;
      
      try {
        // Supprimer de Firebase
        await deleteDoc(doc(db, 'messages', messageId));
        
        // Supprimer l'image d'Imgur si c'est une image
        if (imageDeleteHash) {
          try {
            await fetch(`https://api.imgur.com/3/image/${imageDeleteHash}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Client-ID ${IMGUR_CLIENT_ID}`,
              }
            });
          } catch (e) {
            console.warn('Impossible de supprimer l\'image Imgur:', e);
          }
        }
        
      } catch (error) {
        showError('Erreur suppression: ' + error.message);
      }
    }

    async function editMessage(messageId, currentText) {
      const newText = prompt('Modifier le message:', currentText);
      if (!newText || newText === currentText) return;
      
      try {
        await updateDoc(doc(db, 'messages', messageId), {
          text: newText,
          edited: true,
          editedAt: serverTimestamp()
        });
      } catch (error) {
        showError('Erreur modification: ' + error.message);
      }
    }

    async function logout() {
      try {
        await signOut(auth);
      } catch (error) {
        showError('Erreur d√©connexion: ' + error.message);
      }
    }

    function showError(message) {
      authError.textContent = message;
      authError.classList.remove('hidden');
      setTimeout(hideError, 5000);
    }

    function hideError() {
      authError.classList.add('hidden');
    }

    function showUploadStatus(message) {
      uploadStatus.textContent = message;
      uploadStatus.classList.remove('hidden');
    }

    function hideUploadStatus() {
      uploadStatus.classList.add('hidden');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function openImageModal(imageUrl, fileName) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; justify-content: center;
        align-items: center; z-index: 9999; cursor: pointer;
      `;
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.alt = fileName;
      img.style.cssText = `
        max-width: 90%; max-height: 90%; border: 5px solid lime;
        border-radius: 15px; cursor: default;
      `;
      
      modal.appendChild(img);
      document.body.appendChild(modal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    // Fonctions globales
    window.sendMessage = sendMessage;
    window.logout = logout;
    window.deleteMessage = deleteMessage;
    window.editMessage = editMessage;
    window.openImageModal = openImageModal;

    initFirebase();
  </script>

  <script>
    function showSection(sectionName) {
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => card.classList.remove('active'));
      
      const targetSection = document.getElementById(sectionName);
      if (targetSection) {
        targetSection.classList.add('active');
      }
    }

    window.showSection = showSection;
  </script>
</body>
</html>


