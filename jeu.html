<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Card Clash</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        body {
            font-family: 'Orbitron', sans-serif;
            background: #000 url('https://www.transparenttextures.com/patterns/stardust.png');
            color: #fff;
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .hidden { display: none !important; }

        /* √âcrans de menu */
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        .screen h1 {
            font-size: 4em;
            color: #00ffea;
            text-shadow: 0 0 20px #00ffea;
            margin-bottom: 40px;
        }
        .screen button {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            padding: 15px 30px;
            border: 2px solid #00ffea;
            background: transparent;
            color: #00ffea;
            cursor: pointer;
            transition: all 0.3s;
        }
        .screen button:hover {
            background: #00ffea;
            color: #000;
            box-shadow: 0 0 20px #00ffea;
        }

        /* Interface de jeu */
        #game-board {
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            width: 100vw;
            height: 100vh;
        }

        .player-area {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        #opponent-area {
            transform: rotate(180deg);
        }

        .hand {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 10px;
            padding: 10px;
        }
        
        .card {
            width: 100px;
            height: 140px;
            background: linear-gradient(145deg, #2c3e50, #4ca1af);
            border: 2px solid #7f8c8d;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .card:hover {
            transform: translateY(-20px) scale(1.1);
            border-color: #00ffea;
        }
        .card .cost { position: absolute; top: 5px; left: 5px; font-size: 1.2em; }
        .card .power { position: absolute; bottom: 5px; right: 5px; font-size: 1.2em; }
        .card .name { font-size: 0.9em; text-align: center; }
        .card .art { flex-grow: 1; font-size: 2em; display:flex; align-items:center; justify-content:center; }

        .play-area {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            border-top: 2px solid #00ffea;
            border-bottom: 2px solid #00ffea;
        }

        .location {
            height: 180px;
            background: rgba(0, 255, 234, 0.1);
            border: 2px dashed #00ffea;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        .location-name { font-size: 1.1em; margin-bottom: 5px; }
        .location-power { font-size: 1.5em; }
        .cards-in-location { display: flex; gap: 5px; margin-top: 10px; }

        .game-info {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .game-info div { font-size: 1.2em; }

        #end-turn-btn {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
        }
        
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <h1>Cosmic Card Clash</h1>
        <p>Veuillez vous connecter via la page principale pour jouer.</p>
        <a href="index.html" style="text-decoration: none;"><button>Retour</button></a>
    </div>

    <div id="matchmaking-screen" class="screen hidden">
        <h1>Recherche d'un adversaire...</h1>
        <button onclick="cancelMatchmaking()">Annuler</button>
    </div>

    <div id="game-board" class="hidden">
        <div id="opponent-area" class="player-area">
            <div id="opponent-hand" class="hand"></div>
        </div>
        
        <div class="play-area">
            <div id="location-1" class="location">
                <div class="location-name">N√©buleuse du Chaos</div>
                <div class="location-power" id="loc1-opponent-power">0</div>
                <div id="loc1-opponent-cards" class="cards-in-location"></div>
                <hr style="width:100%;">
                <div id="loc1-player-cards" class="cards-in-location"></div>
                <div class="location-power" id="loc1-player-power">0</div>
            </div>
            <div id="location-2" class="location">
                <div class="location-name">Anomalie Temporelle</div>
                <div class="location-power" id="loc2-opponent-power">0</div>
                <div id="loc2-opponent-cards" class="cards-in-location"></div>
                <hr style="width:100%;">
                <div id="loc2-player-cards" class="cards-in-location"></div>
                <div class="location-power" id="loc2-player-power">0</div>
            </div>
            <div id="location-3" class="location">
                <div class="location-name">Singularit√© √ânerg√©tique</div>
                <div class="location-power" id="loc3-opponent-power">0</div>
                <div id="loc3-opponent-cards" class="cards-in-location"></div>
                <hr style="width:100%;">
                <div id="loc3-player-cards" class="cards-in-location"></div>
                <div class="location-power" id="loc3-player-power">0</div>
            </div>
        </div>

        <div id="player-area" class="player-area">
            <div id="player-hand" class="hand"></div>
        </div>

        <div class="game-info">
            <div>Tour: <span id="turn-counter">1</span>/6</div>
            <div>√ânergie: <span id="energy-counter">1</span></div>
        </div>

        <button id="end-turn-btn" onclick="endTurn()">Fin du Tour</button>
    </div>
    
    <div id="game-over-screen" class="screen hidden">
        <h1 id="game-result"></h1>
        <button onclick="startMatchmaking()">Rejouer</button>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, limit, getDocs, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
          apiKey: "AIzaSyBhyxeEHBKrhuECJKt2d7NwSN7lcv39IX0",
          authDomain: "frieren-2-79e0c.firebaseapp.com",
          projectId: "frieren-2-79e0c",
          storageBucket: "frieren-2-79e0c.appspot.com",
          messagingSenderId: "861104473745",
          appId: "1:861104473745:web:377da7b0daaf5570572130"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentGameId = null;
        let gameListener = null;
        let playerNumber = null;

        const cardDatabase = [
            { id: 1, name: "Soldat Stellaire", cost: 1, power: 2, art: "üßë‚ÄçüöÄ" },
            { id: 2, name: "Drone de D√©fense", cost: 2, power: 3, art: "üõ∞Ô∏è" },
            { id: 3, name: "Amiral de Flotte", cost: 3, power: 4, art: "üë®‚Äç‚úàÔ∏è" },
            { id: 4, name: "Vaisseau Amiral", cost: 6, power: 10, art: "üöÄ" },
            // ... Ajoutez plus de cartes
        ];

        // GESTION DE L'√âTAT D'AUTH
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                startMatchmaking();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        // MATCHMAKING
        window.startMatchmaking = async () => {
            document.getElementById('matchmaking-screen').classList.remove('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');

            const q = query(collection(db, "ccc-games"), where("status", "==", "waiting"), limit(1));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const gameDoc = querySnapshot.docs[0];
                if (gameDoc.data().player1 !== currentUser.uid) {
                    currentGameId = gameDoc.id;
                    playerNumber = 2;
                    await updateDoc(doc(db, "ccc-games", currentGameId), {
                        player2: currentUser.uid,
                        status: "playing"
                    });
                    startGame();
                }
            } else {
                const newGame = createNewGameState();
                const gameRef = await addDoc(collection(db, "ccc-games"), newGame);
                currentGameId = gameRef.id;
                playerNumber = 1;
                listenToGame();
            }
        };
        
        window.cancelMatchmaking = async () => {
            if (currentGameId && playerNumber === 1) {
                await deleteDoc(doc(db, "ccc-games", currentGameId));
            }
            if(gameListener) gameListener();
            document.getElementById('matchmaking-screen').classList.add('hidden');
        };

        // GESTION DU JEU
        const createNewGameState = () => ({
            player1: currentUser.uid,
            player2: null,
            status: "waiting",
            turn: 1,
            player1State: { energy: 1, hand: [], deck: shuffleDeck(), playedCards: {} },
            player2State: { energy: 1, hand: [], deck: shuffleDeck(), playedCards: {} },
            locations: generateLocations(),
        });

        const shuffleDeck = () => {
            // Pour un vrai jeu, cr√©ez un deck pour chaque joueur
            return cardDatabase.sort(() => 0.5 - Math.random());
        };

        const generateLocations = () => ["N√©buleuse", "Anomalie", "Singularit√©"];

        const startGame = () => {
            document.getElementById('matchmaking-screen').classList.add('hidden');
            document.getElementById('game-board').classList.remove('hidden');
            listenToGame();
        };

        const listenToGame = () => {
            if (gameListener) gameListener();
            gameListener = onSnapshot(doc(db, "ccc-games", currentGameId), (doc) => {
                const gameState = doc.data();
                if (gameState && gameState.status === 'playing') {
                    updateUI(gameState);
                } else if (gameState && gameState.status === 'finished') {
                    showGameOver(gameState);
                }
            });
        };

        const updateUI = (gameState) => {
            const myState = playerNumber === 1 ? gameState.player1State : gameState.player2State;
            const opponentState = playerNumber === 1 ? gameState.player2State : gameState.player1State;

            document.getElementById('turn-counter').innerText = gameState.turn;
            document.getElementById('energy-counter').innerText = myState.energy;

            // Mettre √† jour les mains
            updateHand(myState.hand, 'player-hand');
            updateHand(opponentState.hand, 'opponent-hand', true);
            
            // ... Mettre √† jour le plateau de jeu
        };
        
        const updateHand = (hand, elementId, isOpponent = false) => {
            const handEl = document.getElementById(elementId);
            handEl.innerHTML = '';
            hand.forEach(cardId => {
                const card = isOpponent ? 
                    { name: "Carte", art: "‚ùì" } : 
                    cardDatabase.find(c => c.id === cardId);
                
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.innerHTML = `<div class="name">${card.name}</div><div class="art">${card.art}</div>`;
                handEl.appendChild(cardEl);
            });
        };
        
        window.endTurn = async () => {
            // Logique de fin de tour ici
        };
        
        const showGameOver = (gameState) => {
            // Logique de fin de partie
            document.getElementById('game-board').classList.add('hidden');
            document.getElementById('game-over-screen').classList.remove('hidden');
        };

    </script>
</body>
</html>
