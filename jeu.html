<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Card Clash</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        body {
            font-family: 'Orbitron', sans-serif;
            background: #000 url('https://www.transparenttextures.com/patterns/stardust.png');
            color: #fff;
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .hidden { display: none !important; }

        /* √âcrans de menu */
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        .screen h1 {
            font-size: 4em;
            color: #00ffea;
            text-shadow: 0 0 20px #00ffea;
            margin-bottom: 40px;
        }
        .screen button {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            padding: 15px 30px;
            border: 2px solid #00ffea;
            background: transparent;
            color: #00ffea;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .screen button:hover {
            background: #00ffea;
            color: #000;
            box-shadow: 0 0 20px #00ffea;
        }

        /* Interface de jeu */
        #game-board {
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            width: 100vw;
            height: 100vh;
        }

        .player-area {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        #opponent-area {
            transform: rotate(180deg);
        }

        .hand {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 10px;
            padding: 10px;
            height: 160px;
        }
        
        .card {
            width: 100px;
            height: 140px;
            background: linear-gradient(145deg, #2c3e50, #4ca1af);
            border: 2px solid #7f8c8d;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .card:hover {
            transform: translateY(-20px) scale(1.1);
            border-color: #00ffea;
        }
        .card.playable {
            border-color: #00ffea;
            box-shadow: 0 0 15px #00ffea;
        }
        .card .cost { position: absolute; top: 5px; left: 5px; font-size: 1.2em; font-weight: bold; color: yellow; text-shadow: 0 0 5px #000; }
        .card .power { position: absolute; bottom: 5px; right: 5px; font-size: 1.2em; font-weight: bold; color: #ff4d4d; text-shadow: 0 0 5px #000; }
        .card .name { font-size: 0.9em; text-align: center; }
        .card .art { flex-grow: 1; font-size: 2em; display:flex; align-items:center; justify-content:center; }

        .play-area {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            border-top: 2px solid #00ffea;
            border-bottom: 2px solid #00ffea;
            background: rgba(0, 50, 50, 0.2);
        }

        .location {
            height: 200px;
            background: rgba(0, 255, 234, 0.1);
            border: 2px dashed #00ffea;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            transition: all 0.3s;
        }
        .location.highlight {
            background: rgba(0, 255, 234, 0.3);
            border-style: solid;
        }
        .location-name { font-size: 1.1em; margin-bottom: 5px; text-align: center; }
        .location-power { font-size: 1.5em; font-weight: bold; }
        .cards-in-location { display: flex; gap: 5px; height: 50px; align-items: center; }
        .mini-card { width: 30px; height: 42px; background: #2c3e50; border: 1px solid #00ffea; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; }

        .game-info {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 10px;
        }
        .game-info div { font-size: 1.2em; }

        #end-turn-btn {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            font-size: 1.5em !important;
        }
        
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <h1>Cosmic Card Clash</h1>
        <p>Veuillez vous connecter via la page principale pour jouer.</p>
        <a href="index.html" style="text-decoration: none;"><button>Retour</button></a>
    </div>

    <div id="matchmaking-screen" class="screen hidden">
        <h1>Recherche d'un adversaire...</h1>
        <button onclick="cancelMatchmaking()">Annuler</button>
    </div>

    <div id="game-board" class="hidden">
        <div id="opponent-area" class="player-area">
            <div id="opponent-hand" class="hand"></div>
        </div>
        
        <div class="play-area">
            <div id="location-1" class="location">
                <div class="location-name">N√©buleuse</div>
                <div class="location-power" id="loc1-opponent-power">0</div>
                <div id="loc1-opponent-cards" class="cards-in-location"></div>
                <hr style="width:100%; border-color: #00ffea;">
                <div id="loc1-player-cards" class="cards-in-location"></div>
                <div class="location-power" id="loc1-player-power">0</div>
            </div>
            <div id="location-2" class="location">
                <div class="location-name">Anomalie</div>
                <div class="location-power" id="loc2-opponent-power">0</div>
                <div id="loc2-opponent-cards" class="cards-in-location"></div>
                <hr style="width:100%; border-color: #00ffea;">
                <div id="loc2-player-cards" class="cards-in-location"></div>
                <div class="location-power" id="loc2-player-power">0</div>
            </div>
            <div id="location-3" class="location">
                <div class="location-name">Singularit√©</div>
                <div class="location-power" id="loc3-opponent-power">0</div>
                <div id="loc3-opponent-cards" class="cards-in-location"></div>
                <hr style="width:100%; border-color: #00ffea;">
                <div id="loc3-player-cards" class="cards-in-location"></div>
                <div class="location-power" id="loc3-player-power">0</div>
            </div>
        </div>

        <div id="player-area" class="player-area">
            <div id="player-hand" class="hand"></div>
        </div>

        <div class="game-info">
            <div>Tour: <span id="turn-counter">1</span>/6</div>
            <div>√ânergie: <span id="energy-counter">1</span></div>
        </div>

        <button id="end-turn-btn" onclick="endTurn()">Fin du Tour</button>
    </div>
    
    <div id="game-over-screen" class="screen hidden">
        <h1 id="game-result"></h1>
        <button onclick="startMatchmaking()">Rejouer</button>
        <a href="index.html" style="text-decoration: none;"><button>Menu Principal</button></a>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, limit, getDocs, updateDoc, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
          apiKey: "AIzaSyBhyxeEHBKrhuECJKt2d7NwSN7lcv39IX0",
          authDomain: "frieren-2-79e0c.firebaseapp.com",
          projectId: "frieren-2-79e0c",
          storageBucket: "frieren-2-79e0c.appspot.com",
          messagingSenderId: "861104473745",
          appId: "1:861104473745:web:377da7b0daaf5570572130"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentGameId = null;
        let gameListener = null;
        let playerNumber = null;

        const cardDatabase = [
            { id: 1, name: "Soldat Stellaire", cost: 1, power: 2, art: "üßë‚ÄçüöÄ" },
            { id: 2, name: "Drone de D√©fense", cost: 2, power: 3, art: "üõ∞Ô∏è" },
            { id: 3, name: "Amiral de Flotte", cost: 3, power: 4, art: "üë®‚Äç‚úàÔ∏è" },
            { id: 4, name: "Vaisseau Amiral", cost: 6, power: 10, art: "üöÄ" },
            { id: 5, name: "M√©cha de Combat", cost: 4, power: 6, art: "ü§ñ" },
            { id: 6, name: "Technicien Agile", cost: 1, power: 1, art: "üîß" },
            { id: 7, name: "Croiseur Lourd", cost: 5, power: 8, art: "üõ∏" },
        ];

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                startMatchmaking();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('matchmaking-screen').classList.add('hidden');
                document.getElementById('game-board').classList.add('hidden');
            }
        });

        window.startMatchmaking = async () => {
            document.getElementById('matchmaking-screen').classList.remove('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('game-board').classList.add('hidden');

            const q = query(collection(db, "ccc-games"), where("status", "==", "waiting"), limit(1));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const gameDoc = querySnapshot.docs[0];
                if (gameDoc.data().player1 !== currentUser.uid) {
                    currentGameId = gameDoc.id;
                    playerNumber = 2;
                    
                    const batch = writeBatch(db);
                    const gameRef = doc(db, "ccc-games", currentGameId);
                    
                    const p1Deck = shuffleDeck();
                    const p2Deck = shuffleDeck();

                    batch.update(gameRef, {
                        player2: currentUser.uid,
                        status: "playing",
                        'player1State.deck': p1Deck,
                        'player1State.hand': p1Deck.splice(0,3),
                        'player2State.deck': p2Deck,
                        'player2State.hand': p2Deck.splice(0,3),
                    });
                    
                    await batch.commit();
                    listenToGame();
                }
            } else {
                const newGameRef = doc(collection(db, "ccc-games"));
                currentGameId = newGameRef.id;
                playerNumber = 1;
                await setDoc(newGameRef, createNewGameState());
                listenToGame();
            }
        };
        
        window.cancelMatchmaking = async () => {
            if (gameListener) gameListener();
            if (currentGameId && playerNumber === 1) {
                await deleteDoc(doc(db, "ccc-games", currentGameId));
            }
            currentGameId = null;
            document.getElementById('matchmaking-screen').classList.add('hidden');
        };

        const createNewGameState = () => ({
            player1: currentUser.uid,
            player2: null,
            status: "waiting",
            turn: 1,
            player1State: { energy: 1, hand: [], deck: [], playedCards: {} },
            player2State: { energy: 1, hand: [], deck: [], playedCards: {} },
            locations: generateLocations(),
        });

        const shuffleDeck = () => cardDatabase.map(c => c.id).sort(() => 0.5 - Math.random());
        const generateLocations = () => ["N√©buleuse", "Anomalie", "Singularit√©"];

        const listenToGame = () => {
            if (gameListener) gameListener();
            gameListener = onSnapshot(doc(db, "ccc-games", currentGameId), (doc) => {
                if(!doc.exists()) return;
                const gameState = doc.data();
                if (gameState.status === 'playing') {
                    if(document.getElementById('matchmaking-screen').classList.contains('hidden') === false) {
                        document.getElementById('matchmaking-screen').classList.add('hidden');
                        document.getElementById('game-board').classList.remove('hidden');
                    }
                    updateUI(gameState);
                } else if (gameState.status === 'finished') {
                    if(gameListener) gameListener();
                    showGameOver(gameState);
                }
            });
        };
        
        const updateUI = (gameState) => {
            const myState = playerNumber === 1 ? gameState.player1State : gameState.player2State;
            const opponentState = playerNumber === 1 ? gameState.player2State : gameState.player1State;

            document.getElementById('turn-counter').innerText = `${gameState.turn}/6`;
            document.getElementById('energy-counter').innerText = myState.energy;

            updateHand(myState, 'player-hand');
            updateHand(opponentState, 'opponent-hand', true);
        };
        
        const updateHand = (state, elementId, isOpponent = false) => {
            const handEl = document.getElementById(elementId);
            handEl.innerHTML = '';
            state.hand.forEach(cardId => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';

                if (isOpponent) {
                    cardEl.innerHTML = `<div class="name">Carte</div><div class="art">‚ùì</div>`;
                } else {
                    const card = cardDatabase.find(c => c.id === cardId);
                    cardEl.innerHTML = `
                        <div class="cost">${card.cost}</div>
                        <div class="name">${card.name}</div>
                        <div class="art">${card.art}</div>
                        <div class="power">${card.power}</div>
                    `;
                    if (state.energy >= card.cost) {
                        cardEl.classList.add('playable');
                    }
                }
                handEl.appendChild(cardEl);
            });
        };

        const showGameOver = (gameState) => {
            document.getElementById('game-board').classList.add('hidden');
            document.getElementById('game-over-screen').classList.remove('hidden');
            // Ajoutez ici la logique pour d√©terminer le gagnant
            document.getElementById('game-result').innerText = "PARTIE TERMIN√âE";
        };

    </script>
</body>
</html>
