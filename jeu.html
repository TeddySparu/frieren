<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frieren & Jägermaister - Brawl</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        body {
            font-family: 'Orbitron', sans-serif;
            background: #0d0d1a;
            color: #fff;
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .hidden { display: none !important; }

        /* Écrans de menu (matchmaking, game over, etc.) */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(13, 13, 26, 0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            text-align: center;
        }
        .screen h1 {
            font-size: 3.5em;
            color: #ff00ff;
            text-shadow: 0 0 15px #ff00ff, 0 0 25px #ff00ff;
            margin-bottom: 40px;
        }
        .screen button {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            padding: 15px 30px;
            border: 2px solid #ff00ff;
            background: transparent;
            color: #ff00ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 0 10px #ff00ff;
        }
        .screen button:hover {
            background: #ff00ff;
            color: #0d0d1a;
        }

        /* Conteneur du jeu */
        #game-container {
            position: relative;
            border: 3px solid #ff00ff;
            box-shadow: 0 0 20px #ff00ff;
        }
        
        canvas {
            display: block;
            background-color: #1a1a33;
        }

        /* HUD (Informations en jeu) */
        #hud {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            pointer-events: none;
        }
        .player-hud {
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 3px 3px 5px #000;
        }
        #player1-hud { color: #00ffff; }
        #player2-hud { color: #ff6600; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <h1>F&J Brawl</h1>
        <p>Veuillez vous connecter via la page principale pour jouer.</p>
        <a href="index.html" style="text-decoration: none;"><button>Retour au menu</button></a>
    </div>

    <div id="matchmaking-screen" class="screen hidden">
        <h1>Recherche d'un adversaire...</h1>
        <button onclick="window.game.cancelMatchmaking()">Annuler</button>
    </div>

    <div id="game-container" class="hidden">
        <canvas id="game-canvas"></canvas>
        <div id="hud">
            <div id="player1-hud" class="player-hud">P1: 0%</div>
            <div id="player2-hud" class="player-hud">P2: 0%</div>
        </div>
    </div>
    
    <div id="game-over-screen" class="screen hidden">
        <h1 id="game-result"></h1>
        <button onclick="window.game.startMatchmaking()">Rejouer</button>
        <a href="index.html" style="text-decoration: none;"><button>Menu Principal</button></a>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, collection, query, where, limit, getDocs, updateDoc, deleteDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBhyxeEHBKrhuECJKt2d7NwSN7lcv39IX0",
          authDomain: "frieren-2-79e0c.firebaseapp.com",
          projectId: "frieren-2-79e0c",
          storageBucket: "frieren-2-79e0c.appspot.com",
          messagingSenderId: "861104473745",
          appId: "1:861104473745:web:377da7b0daaf5570572130"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTES DU JEU ---
        const CANVAS_WIDTH = 1000;
        const CANVAS_HEIGHT = 600;
        const GRAVITY = 0.5;
        const PLAYER_SPEED = 5;
        const JUMP_FORCE = -12;
        const PLAYER_SIZE = 40;

        // --- CLASSE PRINCIPALE DU JEU ---
        class Game {
            constructor() {
                this.currentUser = null;
                this.currentGameId = null;
                this.gameListener = null;
                this.playerNumber = null; // 1 ou 2
                this.players = {};
                this.platforms = [];
                this.keys = {};
                this.animationFrameId = null;

                this.canvas = document.getElementById('game-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = CANVAS_WIDTH;
                this.canvas.height = CANVAS_HEIGHT;

                this.initUI();
            }

            initUI() {
                this.loginScreen = document.getElementById('login-screen');
                this.matchmakingScreen = document.getElementById('matchmaking-screen');
                this.gameContainer = document.getElementById('game-container');
                this.gameOverScreen = document.getElementById('game-over-screen');
                this.player1Hud = document.getElementById('player1-hud');
                this.player2Hud = document.getElementById('player2-hud');
            }

            authCheck() {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        this.currentUser = user;
                        this.loginScreen.classList.add('hidden');
                        this.startMatchmaking();
                    } else {
                        this.loginScreen.classList.remove('hidden');
                        this.cleanup();
                    }
                });
            }

            async startMatchmaking() {
                this.cleanup();
                this.matchmakingScreen.classList.remove('hidden');

                const q = query(collection(db, "brawl-games"), where("status", "==", "waiting"), limit(1));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const gameDoc = querySnapshot.docs[0];
                    if (gameDoc.data().player1.uid !== this.currentUser.uid) {
                        this.currentGameId = gameDoc.id;
                        this.playerNumber = 2;
                        await updateDoc(doc(db, "brawl-games", this.currentGameId), {
                            "player2.uid": this.currentUser.uid,
                            status: "playing",
                            lastUpdate: serverTimestamp()
                        });
                        this.listenToGame();
                    }
                } else {
                    const newGameRef = doc(collection(db, "brawl-games"));
                    this.currentGameId = newGameRef.id;
                    this.playerNumber = 1;
                    await setDoc(newGameRef, this.getInitialGameState());
                    this.listenToGame();
                }
            }
            
            async cancelMatchmaking() {
                if (this.gameListener) this.gameListener();
                if (this.currentGameId && this.playerNumber === 1) {
                    await deleteDoc(doc(db, "brawl-games", this.currentGameId));
                }
                this.cleanup();
                this.matchmakingScreen.classList.add('hidden');
            }

            getInitialGameState() {
                const spawnX = this.playerNumber === 1 ? CANVAS_WIDTH / 4 : (CANVAS_WIDTH / 4) * 3;
                return {
                    status: "waiting",
                    player1: { uid: this.currentUser.uid, x: CANVAS_WIDTH / 4, y: 100, vx: 0, vy: 0, damage: 0, facing: 1, isAttacking: false, stocks: 3 },
                    player2: { uid: null, x: (CANVAS_WIDTH / 4) * 3, y: 100, vx: 0, vy: 0, damage: 0, facing: -1, isAttacking: false, stocks: 3 },
                    lastUpdate: serverTimestamp(),
                    winner: null
                };
            }
            
            listenToGame() {
                if (this.gameListener) this.gameListener();
                this.gameListener = onSnapshot(doc(db, "brawl-games", this.currentGameId), (doc) => {
                    if (!doc.exists()) return this.cleanup();
                    
                    const gameState = doc.data();
                    if (gameState.status === 'playing') {
                        if (this.animationFrameId === null) this.startGame(gameState);
                        this.players = { p1: gameState.player1, p2: gameState.player2 };
                    } else if (gameState.status === 'finished') {
                        this.endGame(gameState.winner);
                    }
                });
            }

            startGame(initialState) {
                this.matchmakingScreen.classList.add('hidden');
                this.gameContainer.classList.remove('hidden');

                // Définir les plateformes
                this.platforms = [
                    { x: 100, y: 450, width: 800, height: 20 }, // Main platform
                    { x: 200, y: 300, width: 200, height: 15 },
                    { x: 600, y: 300, width: 200, height: 15 }
                ];

                this.players = { p1: initialState.player1, p2: initialState.player2 };
                
                this.setupKeyboardListeners();
                this.gameLoop();
            }

            gameLoop() {
                this.update();
                this.draw();
                this.animationFrameId = requestAnimationFrame(() => this.gameLoop());
            }

            update() {
                if (!this.players.p1 || !this.players.p2) return;

                const myPlayerKey = this.playerNumber === 1 ? 'p1' : 'p2';
                const myPlayer = this.players[myPlayerKey];

                // --- LOGIQUE LOCALE DU JOUEUR ---
                // Mouvement
                myPlayer.vx = 0;
                if (this.keys['ArrowLeft']) { myPlayer.vx = -PLAYER_SPEED; myPlayer.facing = -1; }
                if (this.keys['ArrowRight']) { myPlayer.vx = PLAYER_SPEED; myPlayer.facing = 1; }

                // Physique
                myPlayer.x += myPlayer.vx;
                myPlayer.vy += GRAVITY;
                myPlayer.y += myPlayer.vy;

                // Collision avec les plateformes
                let onGround = false;
                this.platforms.forEach(platform => {
                    if (myPlayer.y + PLAYER_SIZE >= platform.y && myPlayer.y + PLAYER_SIZE <= platform.y + platform.height &&
                        myPlayer.x + PLAYER_SIZE >= platform.x && myPlayer.x <= platform.x + platform.width && myPlayer.vy > 0) {
                        myPlayer.vy = 0;
                        myPlayer.y = platform.y - PLAYER_SIZE;
                        onGround = true;
                    }
                });
                
                // Saut
                if (this.keys['ArrowUp'] && onGround) {
                    myPlayer.vy = JUMP_FORCE;
                }
                
                // Attaque
                myPlayer.isAttacking = !!this.keys['Space'];

                // --- ENVOI DE L'ÉTAT À FIREBASE ---
                this.sendStateToFirestore(myPlayer);
            }
            
            async sendStateToFirestore(myPlayerData) {
                const updatePath = this.playerNumber === 1 ? "player1" : "player2";
                await updateDoc(doc(db, "brawl-games", this.currentGameId), {
                    [updatePath]: myPlayerData
                });
            }

            draw() {
                this.ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

                // Dessiner les plateformes
                this.ctx.fillStyle = '#8c8cde';
                this.platforms.forEach(p => this.ctx.fillRect(p.x, p.y, p.width, p.height));

                // Dessiner les joueurs
                if (this.players.p1) this.drawPlayer(this.players.p1, '#00ffff');
                if (this.players.p2) this.drawPlayer(this.players.p2, '#ff6600');
                
                // Mettre à jour le HUD
                this.player1Hud.textContent = `P1: ${this.players.p1?.damage || 0}%`;
                this.player2Hud.textContent = `P2: ${this.players.p2?.damage || 0}%`;
            }

            drawPlayer(player, color) {
                this.ctx.fillStyle = color;
                this.ctx.fillRect(player.x, player.y, PLAYER_SIZE, PLAYER_SIZE);
                
                // Dessiner l'attaque
                if (player.isAttacking) {
                    this.ctx.fillStyle = 'yellow';
                    const attackX = player.x + (player.facing === 1 ? PLAYER_SIZE : -20);
                    this.ctx.fillRect(attackX, player.y + 10, 20, 20);
                }
            }

            setupKeyboardListeners() {
                window.addEventListener('keydown', e => this.keys[e.code] = true);
                window.addEventListener('keyup', e => this.keys[e.code] = false);
            }
            
            endGame(winnerUID) {
                this.cleanup();
                this.gameContainer.classList.add('hidden');
                this.gameOverScreen.classList.remove('hidden');
                const resultEl = document.getElementById('game-result');
                if(winnerUID === this.currentUser.uid) {
                    resultEl.textContent = "VICTOIRE !";
                    resultEl.style.color = "#00ffff";
                } else {
                    resultEl.textContent = "DÉFAITE...";
                    resultEl.style.color = "#ff6600";
                }
            }

            cleanup() {
                if (this.animationFrameId) cancelAnimationFrame(this.animationFrameId);
                if (this.gameListener) this.gameListener();
                this.animationFrameId = null;
                this.gameListener = null;
                this.currentGameId = null;
                this.playerNumber = null;
                this.players = {};
                this.keys = {};
                this.gameOverScreen.classList.add('hidden');
                this.gameContainer.classList.add('hidden');
            }
        }

        // --- DÉMARRAGE ---
        window.game = new Game();
        window.game.authCheck();

    </script>
</body>
</html>
